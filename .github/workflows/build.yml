name: Build

on:
  push:
    branches: [ build ]
  pull_request:
    branches: [ build ]
  workflow_dispatch:
    # gh api repos/:owner/:repo/actions/workflows/build.yml/dispatches -F ref=master
    # gh workflow run build.yml --ref develop
    # gh workflow run build.yml

jobs:

  build-linux:
    runs-on: ubuntu-latest
    if: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Get KALDI_BRANCH (kag-$TAG tag if commit is tagged; current branch name if not)
        run: |
          export TAG=$(git tag --points-at HEAD)
          echo "TAG: $TAG"
          if [[ $TAG ]]; then
            echo "KALDI_BRANCH=kag-$TAG" >> $GITHUB_ENV
          else
            echo "KALDI_BRANCH=${GITHUB_REF/refs\/heads\//}" >> $GITHUB_ENV
          fi

      - name: Setup just
        run: |
          ls -al $HOME
          mkdir $HOME/bin
          curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to $HOME/bin/
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Build with dockcross
        run: |
          echo "KALDI_BRANCH: $KALDI_BRANCH"
          echo "MKL_URL: $MKL_URL"
          # Example MKL_URL: https://registrationcenter-download.intel.com/akdlm/irc_nas/tec/16917/l_mkl_2020.4.304.tgz
          just build-dockcross $KALDI_BRANCH $MKL_URL
          # cp dist/* wheelhouse/
          ls -al wheelhouse/

      - name: Upload Linux wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux
          path: wheelhouse/*

  build-windows:
    runs-on: windows-2025
    if: true
    env:
      VS_VERSION: vs2022
      PLATFORM_TOOLSET: v143
      WINDOWS_TARGET_PLATFORM_VERSION: 10.0
      MKL_VERSION: 2025.1.0
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout main repository
        uses: actions/checkout@v5
        with:
          path: main

      - name: Get KALDI_BRANCH (kag-$TAG tag if commit is tagged; current branch name if not)
        run: |
          export TAG=$(git tag --points-at HEAD)
          if [[ $TAG ]]; then
            echo "KALDI_BRANCH=kag-$TAG" >> $GITHUB_ENV
          else
            echo "KALDI_BRANCH=${GITHUB_REF/refs\/heads\//}" >> $GITHUB_ENV
          fi

      - name: Checkout OpenFST repository
        uses: actions/checkout@v5
        with:
          repository: daanzu/openfst
          path: openfst

      - name: Checkout Kaldi repository
        uses: actions/checkout@v5
        with:
          repository: daanzu/kaldi-fork-active-grammar
          path: kaldi
          ref: ${{ env.KALDI_BRANCH }}

      - name: Gather system information
        run: |
          echo $GITHUB_WORKSPACE
          df -h
          echo "Windows SDK Versions:"
          ls -al '/c/Program Files (x86)/Windows Kits/10/Include/'
          echo "Visual Studio Redistributables:"
          # ls -al '/c/Program Files (x86)/Microsoft Visual Studio/2022/Enterprise/VC/Redist/MSVC/'
          # ls -al '/c/Program Files (x86)/Microsoft Visual Studio/2022/Enterprise/VC/Redist/MSVC/14.26.28720'
          # ls -al '/c/Program Files (x86)/Microsoft Visual Studio/2022/Enterprise/VC/Redist/MSVC/v142'
          # ls -al '/c/Program Files (x86)/Microsoft Visual Studio/2022/Enterprise/VC/Redist/MSVC/14.16.27012/x64/Microsoft.VC141.CRT'
          # ls -al '/c/Program Files (x86)/Microsoft Visual Studio/2022/Enterprise/VC/Redist/MSVC/'*/x64/Microsoft.*.CRT
          # ls -alR /c/Program\ Files\ \(x86\)/Microsoft Visual Studio/2022/Enterprise/VC/Redist/MSVC/
          # ls -alR '/c/Program Files (x86)/Microsoft Visual Studio/'2022/Enterprise/VC/Redist/MSVC/
          vswhere
          vswhere -find 'VC\Redist\**\VC_redist.x64.exe'

      - name: Setup Kaldi build configuration
        run: |
          cd kaldi/windows
          cp kaldiwin_mkl.props kaldiwin.props
          cp variables.props.dev variables.props
          # Set openfst location
          perl -pi -e 's/<OPENFST>.*<\/OPENFST>/<OPENFST>$ENV{GITHUB_WORKSPACE}\\openfst<\/OPENFST>/g' variables.props
          perl -pi -e 's/<OPENFSTLIB>.*<\/OPENFSTLIB>/<OPENFSTLIB>$ENV{GITHUB_WORKSPACE}\\openfst\\build_output<\/OPENFSTLIB>/g' variables.props
          perl generate_solution.pl --vsver ${VS_VERSION} --enable-mkl --noportaudio
          # Add additional libfstscript library to dragonfly build file
          sed -i.bak '$i\
            <ItemDefinitionGroup>\
              <Link>\
                <AdditionalDependencies>libfstscript.lib;%(AdditionalDependencies)</AdditionalDependencies>\
              </Link>\
            </ItemDefinitionGroup>' ../kaldiwin_${VS_VERSION}_MKL/kaldiwin/kaldi-dragonfly/kaldi-dragonfly.vcxproj
          perl get_version.pl

      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v2

      - name: Install MKL
        run: winget install --id=Intel.oneMKL -v "${MKL_VERSION}" -e --accept-package-agreements --accept-source-agreements --disable-interactivity

      - name: Build OpenFST
        shell: cmd
        run: msbuild -t:Build -p:Configuration=Release -p:Platform=x64 -p:PlatformToolset=%PLATFORM_TOOLSET% -maxCpuCount -verbosity:minimal openfst/openfst.sln

      - name: Build Kaldi
        shell: cmd
        run: msbuild -t:Build -p:Configuration=Release -p:Platform=x64 -p:PlatformToolset=%PLATFORM_TOOLSET% -p:WindowsTargetPlatformVersion=%WINDOWS_TARGET_PLATFORM_VERSION% -maxCpuCount -verbosity:minimal kaldi/kaldiwin_%VS_VERSION%_MKL/kaldiwin/kaldi-dragonfly/kaldi-dragonfly.vcxproj

      - name: Build Python wheel
        run: |
          cd main
          python -m pip -V
          python -m pip install --upgrade setuptools wheel scikit-build cmake ninja
          # ls -alR ../
          mkdir -p kaldi_active_grammar/exec/windows
          cp ../kaldi/kaldiwin_${VS_VERSION}_MKL/kaldiwin/kaldi-dragonfly/x64/Release/kaldi-dragonfly.dll kaldi_active_grammar/exec/windows/
          env KALDIAG_SETUP_RAW=1 python setup.py bdist_wheel
          ls -al dist/

      - name: Upload Windows wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-windows
          path: main/dist/*

      # - name: Copy Windows vc_redist
      #   run: |
      #     mkdir -p vc_redist
      #     cp '/c/Program Files (x86)/Microsoft Visual Studio/2022/Enterprise/VC/Redist/MSVC/14.26.28720'/vc_redist.x64.exe vc_redist/
      #     cp '/c/Program Files (x86)/Microsoft Visual Studio/2022/Enterprise/VC/Redist/MSVC/14.26.28720'/x64/Microsoft.*.CRT/* vc_redist/
      # - uses: actions/upload-artifact@v4
      #   with:
      #     name: windows_vc_redist
      #     path: vc_redist/*

  build-macos-arm:
    runs-on: macos-15
    if: true
    env:
      MACOSX_DEPLOYMENT_TARGET: "11.0"
      # MKL_URL: https://registrationcenter-download.intel.com/akdlm/irc_nas/tec/17172/m_mkl_2020.4.301.dmg
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Get KALDI_BRANCH (kag-$TAG tag if commit is tagged; current branch name if not)
        run: |
          export TAG=$(git tag --points-at HEAD)
          if [[ $TAG ]]; then
            echo "KALDI_BRANCH=kag-$TAG" >> $GITHUB_ENV
          else
            echo "KALDI_BRANCH=${GITHUB_REF/refs\/heads\//}" >> $GITHUB_ENV
          fi

      - name: Install dependencies
        run: |
          python3 -m pip install --break-system-packages --user --upgrade setuptools wheel scikit-build cmake ninja
          brew install automake
          # brew install autoconf
          brew install sox
          brew install libtool
          brew reinstall gfortran  # for openblas

      - name: Install MKL (if enabled)
        if: ${{ env.MKL_URL != 0 }}
        run: |
          echo "Installing MKL from: $MKL_URL"
          export MKL_FILE=${MKL_URL##*/}
          export MKL_FILE=${MKL_FILE%\.dmg}
          wget --no-verbose $MKL_URL
          hdiutil attach ${MKL_FILE}.dmg
          cp /Volumes/${MKL_FILE}/${MKL_FILE}.app/Contents/MacOS/silent.cfg .
          sed -i.bak -e 's/decline/accept/g' silent.cfg
          sudo /Volumes/${MKL_FILE}/${MKL_FILE}.app/Contents/MacOS/install.sh --silent silent.cfg

      - name: Build Python wheel
        run: |
          python3 setup.py bdist_wheel
          ls -al dist/

      - name: Upload MacOS ARM wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-arm
          path: dist/*

  build-macos-intel:
    runs-on: macos-13
    if: true
    env:
      MACOSX_DEPLOYMENT_TARGET: "10.9"
      # MKL_URL: https://registrationcenter-download.intel.com/akdlm/irc_nas/tec/17172/m_mkl_2020.4.301.dmg
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Get KALDI_BRANCH (kag-$TAG tag if commit is tagged; current branch name if not)
        run: |
          export TAG=$(git tag --points-at HEAD)
          if [[ $TAG ]]; then
            echo "KALDI_BRANCH=kag-$TAG" >> $GITHUB_ENV
          else
            echo "KALDI_BRANCH=${GITHUB_REF/refs\/heads\//}" >> $GITHUB_ENV
          fi

      - name: Install dependencies
        run: |
          python3 -m pip install --break-system-packages --user --upgrade setuptools wheel scikit-build cmake ninja
          brew install automake
          # brew install autoconf
          brew install sox
          # brew install libtool
          brew reinstall gfortran  # for openblas

      - name: Install MKL (if enabled)
        if: ${{ env.MKL_URL != 0 }}
        run: |
          echo "Installing MKL from: $MKL_URL"
          export MKL_FILE=${MKL_URL##*/}
          export MKL_FILE=${MKL_FILE%\.dmg}
          wget --no-verbose $MKL_URL
          hdiutil attach ${MKL_FILE}.dmg
          cp /Volumes/${MKL_FILE}/${MKL_FILE}.app/Contents/MacOS/silent.cfg .
          sed -i.bak -e 's/decline/accept/g' silent.cfg
          sudo /Volumes/${MKL_FILE}/${MKL_FILE}.app/Contents/MacOS/install.sh --silent silent.cfg

      - name: Build Python wheel
        run: |
          python3 setup.py bdist_wheel
          ls -al dist/

      - name: Upload MacOS Intel wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-intel
          path: dist/*

  merge-wheels:
    runs-on: ubuntu-latest
    needs: [
      build-linux,
      build-windows,
      build-macos-arm,
      build-macos-intel,
    ]
    steps:
      - name: Merge all wheel artifacts
        uses: actions/upload-artifact/merge@v4
        with:
          name: wheels
          pattern: wheels-*
          delete-merged: false  # Optional: removes the individual artifacts
